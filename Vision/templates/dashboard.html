<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hailo AI People Counter Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stats-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: visible;
        }
        
        .chart-container h5 {
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
        }
        
        .chart-container > div:last-child {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        /* Ensure Plotly charts are properly centered */
        .js-plotly-plot {
            width: 100% !important;
            height: 100% !important;
        }
        
        .js-plotly-plot .plotly {
            width: 100% !important;
            height: 100% !important;
        }
        
        .js-plotly-plot .plotly .main-svg {
            width: 100% !important;
            height: 100% !important;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-icon {
            font-size: 2rem;
            color: #764ba2;
        }
        
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            color: #667eea;
            font-size: 1.1rem;
        }
        
        .error-message {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #dc3545;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .error-message i {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .error-message strong {
            margin-bottom: 5px;
        }
        
        .error-message small {
            opacity: 0.8;
        }
        
        /* Hide any debug overlays or unwanted elements */
        .debug-overlay, 
        .plotly-debug,
        [class*="debug"],
        [class*="Debug"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
        
        /* Ensure chart containers are clean */
        .chart-container > div {
            position: relative;
            z-index: 1;
        }
        
        /* Hide any Plotly debug information */
        .js-plotly-plot .plotly .main-svg .debug-info,
        .js-plotly-plot .plotly .main-svg .debug-overlay {
            display: none !important;
        }
        
        /* Hide any red text overlays */
        .chart-container *[style*="color: red"],
        .chart-container *[style*="color: #ff0000"],
        .chart-container *[style*="color: rgb(255, 0, 0)"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
        
        /* Hide any text elements with red color */
        .chart-container * {
            color: inherit !important;
        }
        
        /* Hide any elements with debug-related text content */
        .chart-container *:not(.js-plotly-plot):not(.plotly):not(.main-svg):not(.bglayer):not(.draglayer) {
            color: transparent !important;
            background: transparent !important;
        }
        
        /* Ensure only Plotly chart elements are visible */
        .chart-container .js-plotly-plot,
        .chart-container .js-plotly-plot * {
            color: inherit !important;
        }
        
        /* Ensure chart containers are properly positioned */
        .chart-container {
            position: relative;
            overflow: visible;
            text-align: center;
        }
        
        /* Hide any unwanted overlays */
        .chart-container > div:not(:first-child) {
            position: relative;
            z-index: 1;
        }
        
        /* Fix chart alignment and sizing */
        #timeSeriesChart,
        #hourlyPatternChart,
        #dailySummaryChart,
        #heatmapChart {
            width: 100% !important;
            height: 100% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        /* Ensure Plotly charts fill their containers properly */
        .js-plotly-plot .plotly .main-svg {
            width: 100% !important;
            height: 100% !important;
            max-width: none !important;
        }
        
        /* Fix any margin or padding issues */
        .chart-container .js-plotly-plot {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        @media (max-width: 768px) {
            .stat-value {
                font-size: 2rem;
            }
            
            .stat-icon {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Refresh Indicator -->
    <div class="refresh-indicator" id="refreshIndicator">
        <i class="fas fa-sync-alt"></i> Auto-refresh: <span id="refreshTimer">5</span>s
    </div>

    <!-- Header -->
    <div class="dashboard-header py-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0">
                        <i class="fas fa-chart-line text-primary"></i>
                        Hailo AI People Counter Dashboard
                    </h1>
                    <p class="text-muted mb-0">Real-time people detection analytics</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex align-items-center justify-content-end">
                        <div class="me-3">
                            <small class="text-muted">Last Update:</small><br>
                            <span id="lastUpdate">Loading...</span>
                        </div>
                        <div class="status-indicator">
                            <i class="fas fa-circle text-success" id="statusIndicator"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- Statistics Cards -->
        <div class="row mb-4 justify-content-center" id="statsCards">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card p-4 text-center">
                    <div class="stat-icon mb-2">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-value" id="totalUniquePeople">-</div>
                    <div class="stat-label">Total Unique People</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card p-4 text-center">
                    <div class="stat-icon mb-2">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-value" id="currentMinutePeople">-</div>
                    <div class="stat-label">Current Minute</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card p-4 text-center">
                    <div class="stat-icon mb-2">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="stat-value" id="currentHourPeople">-</div>
                    <div class="stat-label">Current Hour</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stats-card p-4 text-center">
                    <div class="stat-icon mb-2">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-value" id="currentDayPeople">-</div>
                    <div class="stat-label">Current Day</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row justify-content-center">
            <!-- Time Series Chart -->
            <div class="col-lg-8 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-line text-primary"></i> People Detection Over Time</h5>
                    <div id="timeSeriesChart" class="loading">
                        <div><i class="fas fa-spinner fa-spin"></i> Loading chart...</div>
                    </div>
                </div>
            </div>

            <!-- Hourly Pattern Chart -->
            <div class="col-lg-4 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-bar text-primary"></i> Hourly Detection Patterns</h5>
                    <div id="hourlyPatternChart" class="loading">
                        <div><i class="fas fa-spinner fa-spin"></i> Loading chart...</div>
                    </div>
                </div>
            </div>

            <!-- Daily Summary Chart -->
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-area text-primary"></i> Daily Summary</h5>
                    <div id="dailySummaryChart" class="loading">
                        <div><i class="fas fa-spinner fa-spin"></i> Loading chart...</div>
                    </div>
                </div>
            </div>

            <!-- Heatmap Chart -->
            <div class="col-lg-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-th text-primary"></i> Weekly Heatmap</h5>
                    <div id="heatmapChart" class="loading">
                        <div><i class="fas fa-spinner fa-spin"></i> Loading chart...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Range Info -->
        <div class="row">
            <div class="col-12">
                <div class="stats-card p-3">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <small class="text-muted">Data Range</small><br>
                            <span id="dataRange">Loading...</span>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Total Records</small><br>
                            <span id="totalRecords">-</span>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Status</small><br>
                            <span id="connectionStatus" class="text-success">Connected</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Dashboard functionality
        class Dashboard {
            constructor() {
                this.refreshInterval = 5000; // 5 seconds
                this.refreshTimer = 5;
                this.charts = {};
                this.init();
            }

            init() {
                this.startRefreshTimer();
                this.loadData();
                this.loadCharts();
                this.startAutoRefresh();
            }

            startRefreshTimer() {
                setInterval(() => {
                    this.refreshTimer--;
                    document.getElementById('refreshTimer').textContent = this.refreshTimer;
                    
                    if (this.refreshTimer <= 0) {
                        this.refreshTimer = 5;
                        this.refreshData();
                    }
                }, 1000);
            }

            async loadData() {
                try {
                    const response = await fetch('/api/data');
                    const data = await response.json();
                    
                    if (data.error) {
                        this.showError(data.error);
                        return;
                    }

                    this.updateStats(data);
                    this.updateStatus('Connected', 'success');
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.updateStatus('Connection Error', 'danger');
                }
            }

            updateStats(data) {
                document.getElementById('totalUniquePeople').textContent = data.total_unique_people;
                document.getElementById('currentMinutePeople').textContent = data.current_minute_people;
                document.getElementById('currentHourPeople').textContent = data.current_hour_people;
                document.getElementById('currentDayPeople').textContent = data.current_day_people;
                document.getElementById('lastUpdate').textContent = data.last_update;
                document.getElementById('totalRecords').textContent = data.total_records;
                document.getElementById('dataRange').textContent = `${data.data_range.start} to ${data.data_range.end}`;
            }

            async loadCharts() {
                await Promise.all([
                    this.loadChart('timeSeriesChart', '/api/chart/time_series'),
                    this.loadChart('hourlyPatternChart', '/api/chart/hourly_pattern'),
                    this.loadChart('dailySummaryChart', '/api/chart/daily_summary'),
                    this.loadChart('heatmapChart', '/api/chart/heatmap')
                ]);
            }

            async loadChart(containerId, endpoint) {
                try {
                    const response = await fetch(endpoint);
                    const data = await response.json();
                    
                    if (data.error) {
                        document.getElementById(containerId).innerHTML = 
                            `<div class="error-message">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Chart Error:</strong> ${data.error}
                                <br><small>This chart will retry automatically on next refresh.</small>
                            </div>`;
                        return;
                    }

                    const container = document.getElementById(containerId);
                    container.innerHTML = '';
                    
                    Plotly.newPlot(containerId, data.data, data.layout, {
                        responsive: true,
                        displayModeBar: false,
                        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                        displaylogo: false,
                        showTips: false,
                        staticPlot: false,
                        useResizeHandler: true,
                        autosize: true
                    });

                    // Clean up any debug elements that might appear
                    this.cleanupDebugElements(containerId);

                    // Ensure proper chart sizing and centering
                    this.resizeChart(containerId);

                    this.charts[containerId] = data;
                } catch (error) {
                    console.error(`Error loading chart ${containerId}:`, error);
                    document.getElementById(containerId).innerHTML = 
                        `<div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Connection Error:</strong> Failed to load chart
                            <br><small>Check your connection and try refreshing the page.</small>
                        </div>`;
                }
            }

            cleanupDebugElements(containerId) {
                // Remove any debug overlays or unwanted elements
                const container = document.getElementById(containerId);
                if (container) {
                    // Remove elements with debug-related classes or attributes
                    const debugElements = container.querySelectorAll('[class*="debug"], [class*="Debug"], .debug-overlay, .plotly-debug');
                    debugElements.forEach(el => {
                        el.style.display = 'none';
                        el.style.visibility = 'hidden';
                        el.style.opacity = '0';
                    });
                    
                    // Remove any red text overlays
                    const redTextElements = container.querySelectorAll('*');
                    redTextElements.forEach(el => {
                        if (el.style.color === 'red' || el.style.color === '#ff0000') {
                            el.style.display = 'none';
                        }
                        
                        // Remove any text nodes that contain debug information
                        if (el.childNodes) {
                            el.childNodes.forEach(node => {
                                if (node.nodeType === Node.TEXT_NODE && 
                                    (node.textContent.includes('plotly') || 
                                     node.textContent.includes('debug') ||
                                     node.textContent.includes('hover') ||
                                     node.textContent.includes('template'))) {
                                    node.remove();
                                }
                            });
                        }
                    });
                    
                    // Hide any elements that are not part of the actual chart
                    const allElements = container.querySelectorAll('*');
                    allElements.forEach(el => {
                        if (!el.classList.contains('js-plotly-plot') && 
                            !el.classList.contains('plotly') && 
                            !el.classList.contains('main-svg') &&
                            el.style.color === 'red') {
                            el.style.display = 'none';
                            el.style.visibility = 'hidden';
                        }
                    });
                }
            }

            refreshData() {
                this.loadData();
                this.loadCharts();
            }

            startAutoRefresh() {
                setInterval(() => {
                    this.refreshData();
                }, this.refreshInterval);
                
                // Periodic cleanup of debug elements
                setInterval(() => {
                    this.cleanupAllDebugElements();
                }, 2000); // Check every 2 seconds
            }

            cleanupAllDebugElements() {
                // Clean up debug elements from all chart containers
                const chartContainers = ['timeSeriesChart', 'hourlyPatternChart', 'dailySummaryChart', 'heatmapChart'];
                chartContainers.forEach(containerId => {
                    this.cleanupDebugElements(containerId);
                });
            }

            resizeChart(containerId) {
                // Ensure the chart is properly sized and centered
                const container = document.getElementById(containerId);
                if (container && container.querySelector('.js-plotly-plot')) {
                    // Trigger a resize event to ensure proper sizing
                    window.dispatchEvent(new Event('resize'));
                    
                    // Force the chart to redraw with proper dimensions
                    setTimeout(() => {
                        const plotElement = container.querySelector('.js-plotly-plot');
                        if (plotElement && plotElement._fullLayout) {
                            Plotly.relayout(containerId, {
                                autosize: true,
                                width: container.offsetWidth,
                                height: container.offsetHeight
                            });
                        }
                    }, 100);
                }
            }

            updateStatus(message, type) {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.textContent = message;
                statusElement.className = `text-${type}`;
                
                const indicator = document.getElementById('statusIndicator');
                indicator.className = `fas fa-circle text-${type}`;
            }

            showError(message) {
                console.error('Dashboard error:', message);
                this.updateStatus('Error', 'danger');
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new Dashboard();
            
            // Immediate cleanup of any debug elements
            setTimeout(() => {
                const dashboard = new Dashboard();
                dashboard.cleanupAllDebugElements();
            }, 100);
        });
    </script>
</body>
</html> 